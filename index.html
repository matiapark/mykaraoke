// --- 상태 관리 ---
        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                if (isStoppingManually) return;

                if (isSinging) {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                    }
                    if (animationFrameId) {
                        cancelAnimationFrame(animationFrameId);
                        animationFrameId = null;
                    }
                    disableNoSleep();
                    pitch = null;
                    mediaRecorder = null;
                    isSinging = false;
                }

                if (isPlaylistMode) {
                    currentPlaylistIndex++;
                    if (currentPlaylistIndex >= currentPlaylist.length) {
                        currentPlaylistIndex = 0;
                    }
                    const nextSong = currentPlaylist[currentPlaylistIndex];
                    prepareKaraoke(nextSong, true);
                } else {
                    if (player) {
                        player.stopVideo();
                    }
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                }
            }
        }

        // --- 노래방 핵심 로직 ---

        /** 노래방 화면으로 전환하고 노래를 준비합니다. */
        async function prepareKaraoke(songData, isPlaylist = false) {
            if (isPreparing) return;
            isPreparing = true;
            
            currentSongData = songData;
            searchView.style.display = 'none';
            karaokeView.style.display = 'block';
            document.getElementById('karaoke-title').textContent = `${songData.title} - ${songData.artist}`;
            micErrorMessage.style.display = 'none';
            headphoneGuide.style.display = 'flex';
            
            try {
                if (!audioStream || audioStream.getAudioTracks().every(track => track.readyState === 'ended')) {
                    const constraints = { audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true } };
                    audioStream = await navigator.mediaDevices.getUserMedia(constraints);
                }
                if (!audioContext || audioContext.state === 'closed') {
                    audioContext = new AudioContext();
                }
                micErrorMessage.style.display = 'none';
            } catch (err) {
                console.error("마이크 초기화 실패:", err);
                micErrorMessage.textContent = "마이크 사용이 거부되었습니다. 브라우저의 주소창 왼쪽 🔒을 눌러 권한을 허용해주세요.";
                micErrorMessage.style.display = 'block';
                isPreparing = false;
                return;
            }
            
            resetState();
            
            isPlaylistMode = isPlaylist;
            if (!isPlaylistMode) {
                addRecentSong(songData);
            }
            
            if (player) {
                player.cueVideoById(songData.videoId);
            }

            startBtn.disabled = false;
            stopBtn.disabled = true;
            isPreparing = false;
        }

        /** '시작' 버튼: 기존 오디오 자원을 재사용하여 노래와 녹음을 시작합니다. */
        async function startSinging() {
            if (isPreparing || isSinging || !player || !audioStream || !audioContext) return;

            try {
                isSinging = true;
                headphoneGuide.style.display = 'none';
                
                const resultArea = document.getElementById('resultArea');
                resultArea.style.display = 'block';
                resultArea.querySelector('h4').textContent = '녹음 중...';
                document.getElementById('recordedAudio').style.display = 'none';
                document.getElementById('downloadBtn').style.display = 'none';

                pitch = await new Promise((resolve, reject) => {
                    ml5.pitchDetection('https://cdn.jsdelivr.net/gh/ml5js/ml5-data-and-models/models/pitch-detection/crepe/', audioContext, audioStream, (err, model) => {
                        if (err) return reject(err);
                        resolve(model);
                    });
                });
                mediaRecorder = new MediaRecorder(audioStream);
                setupMediaRecorder(currentSongData); 

                player.playVideo();
                mediaRecorder.start();
                getPitch();
                enableNoSleep();
                
                startBtn.disabled = true;
                stopBtn.disabled = false;

            } catch (err) {
                console.error("노래 시작 실패:", err);
                isSinging = false;
            }
        }

        /** '중단' 버튼: 녹음기를 '버려서' 불안정한 stop() 동작을 회피합니다. (수정됨) */
        async function stopSinging() {
            if (!isSinging) return;

            // onPlayerStateChange 이벤트와의 충돌을 막기 위해 플래그 설정
            isStoppingManually = true;

            if (player) {
                player.stopVideo();
            }

            // 음정 분석 루프 중지
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }

            // --- 핵심 수정 ---
            // 불안정한 mediaRecorder.stop()과 onstop 이벤트를 기다리는 대신,
            // 현재 녹음기 인스턴스를 즉시 버리고 가비지 컬렉터가 수거하도록 합니다.
            if (mediaRecorder) {
                mediaRecorder.ondataavailable = null;
                mediaRecorder.onstop = null;
            }
            mediaRecorder = null;
            
            // 모든 상태를 동기적으로 즉시 초기화합니다.
            pitch = null;
            isSinging = false;
            disableNoSleep();
            resetState(); // recordedChunks를 비우고 UI를 정리합니다.

            // 플레이어 상태 변경이 안정화된 후 플래그를 리셋합니다.
            setTimeout(() => { isStoppingManually = false; }, 200);

            // UI 버튼을 재설정합니다.
            startBtn.disabled = false;
            stopBtn.disabled = true;
        }


        /** '선곡하기' 버튼: 모든 리소스를 해제(파괴)하고 검색 화면으로 돌아갑니다. */
        async function returnToSearchView() {
            if (player) player.stopVideo();
            await cleanupAudioResources();
            
            isPlaylistMode = false;
            currentSongData = null;
            
            karaokeView.style.display = 'none';
            searchView.style.display = 'block';
            searchInput.value = '';
            switchView('search');
        }

        /** 모든 오디오 관련 리소스를 안전하게 해제(파괴)합니다. */
        async function cleanupAudioResources() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            
            // '선곡' 등 노래방 기능을 완전히 나갈 때만 스트림과 컨텍스트를 파괴
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
            }
            
            if (audioContext && audioContext.state !== 'closed') {
                await audioContext.close();
            }
            
            pitch = null;
            audioStream = null;
            mediaRecorder = null;
            audioContext = null;
            isSinging = false;
        }
        
        // --- 헬퍼 함수 ---
        function setupMediaRecorder(songForRecording) {
            if (!mediaRecorder) return;
            mediaRecorder.ondataavailable = e => {
                if (e.data.size > 0) recordedChunks.push(e.data);
            };
            mediaRecorder.onstop = () => {
                // 수동 중단 시에는 stopSinging에서 모든 것을 처리하므로,
                // 이 핸들러는 노래가 자연스럽게 끝났을 때만 동작합니다.
                if (isStoppingManually) {
                    return; 
                }
                
                // 녹음 정상 종료 시 파일 저장
                document.getElementById('resultArea').style.display = 'block';
                const resultTitle = document.querySelector('#resultArea h4');
                resultTitle.textContent = '녹음 완료!';
                const audioPlayer = document.getElementById('recordedAudio');
                const downloadBtn = document.getElementById('downloadBtn');
                audioPlayer.style.display = 'block';
                const blob = new Blob(recordedChunks, { type: 'audio/webm' });
                const url = URL.createObjectURL(blob);
                audioPlayer.src = url;
                downloadBtn.style.display = 'inline-block';
                downloadBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.style.display = 'none'; a.href = url;
                    a.download = `나의노래방-${songForRecording.title.trim()} - ${songForRecording.artist.trim()}.webm`;
                    document.body.appendChild(a); a.click(); document.body.removeChild(a);
                };
                recordedChunks = [];
            };
        }

        function getPitch() {
            if (!pitch || !isSinging) {
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
                return;
            }
            pitch.getPitch((err, frequency) => {
                if (isSinging) {
                    drawVisualizer(frequency || 0);
                    animationFrameId = requestAnimationFrame(getPitch);
                }
            });
        }
        
        /** 상태 초기화 (수정됨: recordedChunks 초기화 역할 명확화) */
        function resetState() {
            // 녹음 데이터 청크 배열을 비웁니다.
            recordedChunks = [];
            // 녹음 결과 UI를 숨기고 초기화합니다.
            const resultArea = document.getElementById('resultArea');
            resultArea.style.display = 'none';
            resultArea.querySelector('h4').textContent = '녹음 완료!';
            const recordedAudio = document.getElementById('recordedAudio');
            if (recordedAudio) recordedAudio.src = "";
            document.getElementById('downloadBtn').style.display = 'none';
            clearVisualizer();
        }