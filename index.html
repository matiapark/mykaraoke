// --- ìƒíƒœ ê´€ë¦¬ ---
        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                if (isStoppingManually) return;

                if (isSinging) {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                    }
                    if (animationFrameId) {
                        cancelAnimationFrame(animationFrameId);
                        animationFrameId = null;
                    }
                    disableNoSleep();
                    pitch = null;
                    mediaRecorder = null;
                    isSinging = false;
                }

                if (isPlaylistMode) {
                    currentPlaylistIndex++;
                    if (currentPlaylistIndex >= currentPlaylist.length) {
                        currentPlaylistIndex = 0;
                    }
                    const nextSong = currentPlaylist[currentPlaylistIndex];
                    prepareKaraoke(nextSong, true);
                } else {
                    if (player) {
                        player.stopVideo();
                    }
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                }
            }
        }

        // --- ë…¸ë˜ë°© í•µì‹¬ ë¡œì§ ---

        /** ë…¸ë˜ë°© í™”ë©´ìœ¼ë¡œ ì „í™˜í•˜ê³  ë…¸ë˜ë¥¼ ì¤€ë¹„í•©ë‹ˆë‹¤. */
        async function prepareKaraoke(songData, isPlaylist = false) {
            if (isPreparing) return;
            isPreparing = true;
            
            currentSongData = songData;
            searchView.style.display = 'none';
            karaokeView.style.display = 'block';
            document.getElementById('karaoke-title').textContent = `${songData.title} - ${songData.artist}`;
            micErrorMessage.style.display = 'none';
            headphoneGuide.style.display = 'flex';
            
            try {
                if (!audioStream || audioStream.getAudioTracks().every(track => track.readyState === 'ended')) {
                    const constraints = { audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true } };
                    audioStream = await navigator.mediaDevices.getUserMedia(constraints);
                }
                if (!audioContext || audioContext.state === 'closed') {
                    audioContext = new AudioContext();
                }
                micErrorMessage.style.display = 'none';
            } catch (err) {
                console.error("ë§ˆì´í¬ ì´ˆê¸°í™” ì‹¤íŒ¨:", err);
                micErrorMessage.textContent = "ë§ˆì´í¬ ì‚¬ìš©ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ì˜ ì£¼ì†Œì°½ ì™¼ìª½ ğŸ”’ì„ ëˆŒëŸ¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.";
                micErrorMessage.style.display = 'block';
                isPreparing = false;
                return;
            }
            
            resetState();
            
            isPlaylistMode = isPlaylist;
            if (!isPlaylistMode) {
                addRecentSong(songData);
            }
            
            if (player) {
                player.cueVideoById(songData.videoId);
            }

            startBtn.disabled = false;
            stopBtn.disabled = true;
            isPreparing = false;
        }

        /** 'ì‹œì‘' ë²„íŠ¼: ê¸°ì¡´ ì˜¤ë””ì˜¤ ìì›ì„ ì¬ì‚¬ìš©í•˜ì—¬ ë…¸ë˜ì™€ ë…¹ìŒì„ ì‹œì‘í•©ë‹ˆë‹¤. */
        async function startSinging() {
            if (isPreparing || isSinging || !player || !audioStream || !audioContext) return;

            try {
                isSinging = true;
                headphoneGuide.style.display = 'none';
                
                const resultArea = document.getElementById('resultArea');
                resultArea.style.display = 'block';
                resultArea.querySelector('h4').textContent = 'ë…¹ìŒ ì¤‘...';
                document.getElementById('recordedAudio').style.display = 'none';
                document.getElementById('downloadBtn').style.display = 'none';

                pitch = await new Promise((resolve, reject) => {
                    ml5.pitchDetection('https://cdn.jsdelivr.net/gh/ml5js/ml5-data-and-models/models/pitch-detection/crepe/', audioContext, audioStream, (err, model) => {
                        if (err) return reject(err);
                        resolve(model);
                    });
                });
                mediaRecorder = new MediaRecorder(audioStream);
                setupMediaRecorder(currentSongData); 

                player.playVideo();
                mediaRecorder.start();
                getPitch();
                enableNoSleep();
                
                startBtn.disabled = true;
                stopBtn.disabled = false;

            } catch (err) {
                console.error("ë…¸ë˜ ì‹œì‘ ì‹¤íŒ¨:", err);
                isSinging = false;
            }
        }

        /** 'ì¤‘ë‹¨' ë²„íŠ¼: ë…¹ìŒê¸°ë¥¼ 'ë²„ë ¤ì„œ' ë¶ˆì•ˆì •í•œ stop() ë™ì‘ì„ íšŒí”¼í•©ë‹ˆë‹¤. (ìˆ˜ì •ë¨) */
        async function stopSinging() {
            if (!isSinging) return;

            // onPlayerStateChange ì´ë²¤íŠ¸ì™€ì˜ ì¶©ëŒì„ ë§‰ê¸° ìœ„í•´ í”Œë˜ê·¸ ì„¤ì •
            isStoppingManually = true;

            if (player) {
                player.stopVideo();
            }

            // ìŒì • ë¶„ì„ ë£¨í”„ ì¤‘ì§€
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }

            // --- í•µì‹¬ ìˆ˜ì • ---
            // ë¶ˆì•ˆì •í•œ mediaRecorder.stop()ê³¼ onstop ì´ë²¤íŠ¸ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ëŒ€ì‹ ,
            // í˜„ì¬ ë…¹ìŒê¸° ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¦‰ì‹œ ë²„ë¦¬ê³  ê°€ë¹„ì§€ ì»¬ë ‰í„°ê°€ ìˆ˜ê±°í•˜ë„ë¡ í•©ë‹ˆë‹¤.
            if (mediaRecorder) {
                mediaRecorder.ondataavailable = null;
                mediaRecorder.onstop = null;
            }
            mediaRecorder = null;
            
            // ëª¨ë“  ìƒíƒœë¥¼ ë™ê¸°ì ìœ¼ë¡œ ì¦‰ì‹œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
            pitch = null;
            isSinging = false;
            disableNoSleep();
            resetState(); // recordedChunksë¥¼ ë¹„ìš°ê³  UIë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤.

            // í”Œë ˆì´ì–´ ìƒíƒœ ë³€ê²½ì´ ì•ˆì •í™”ëœ í›„ í”Œë˜ê·¸ë¥¼ ë¦¬ì…‹í•©ë‹ˆë‹¤.
            setTimeout(() => { isStoppingManually = false; }, 200);

            // UI ë²„íŠ¼ì„ ì¬ì„¤ì •í•©ë‹ˆë‹¤.
            startBtn.disabled = false;
            stopBtn.disabled = true;
        }


        /** 'ì„ ê³¡í•˜ê¸°' ë²„íŠ¼: ëª¨ë“  ë¦¬ì†ŒìŠ¤ë¥¼ í•´ì œ(íŒŒê´´)í•˜ê³  ê²€ìƒ‰ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤. */
        async function returnToSearchView() {
            if (player) player.stopVideo();
            await cleanupAudioResources();
            
            isPlaylistMode = false;
            currentSongData = null;
            
            karaokeView.style.display = 'none';
            searchView.style.display = 'block';
            searchInput.value = '';
            switchView('search');
        }

        /** ëª¨ë“  ì˜¤ë””ì˜¤ ê´€ë ¨ ë¦¬ì†ŒìŠ¤ë¥¼ ì•ˆì „í•˜ê²Œ í•´ì œ(íŒŒê´´)í•©ë‹ˆë‹¤. */
        async function cleanupAudioResources() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            
            // 'ì„ ê³¡' ë“± ë…¸ë˜ë°© ê¸°ëŠ¥ì„ ì™„ì „íˆ ë‚˜ê°ˆ ë•Œë§Œ ìŠ¤íŠ¸ë¦¼ê³¼ ì»¨í…ìŠ¤íŠ¸ë¥¼ íŒŒê´´
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
            }
            
            if (audioContext && audioContext.state !== 'closed') {
                await audioContext.close();
            }
            
            pitch = null;
            audioStream = null;
            mediaRecorder = null;
            audioContext = null;
            isSinging = false;
        }
        
        // --- í—¬í¼ í•¨ìˆ˜ ---
        function setupMediaRecorder(songForRecording) {
            if (!mediaRecorder) return;
            mediaRecorder.ondataavailable = e => {
                if (e.data.size > 0) recordedChunks.push(e.data);
            };
            mediaRecorder.onstop = () => {
                // ìˆ˜ë™ ì¤‘ë‹¨ ì‹œì—ëŠ” stopSingingì—ì„œ ëª¨ë“  ê²ƒì„ ì²˜ë¦¬í•˜ë¯€ë¡œ,
                // ì´ í•¸ë“¤ëŸ¬ëŠ” ë…¸ë˜ê°€ ìì—°ìŠ¤ëŸ½ê²Œ ëë‚¬ì„ ë•Œë§Œ ë™ì‘í•©ë‹ˆë‹¤.
                if (isStoppingManually) {
                    return; 
                }
                
                // ë…¹ìŒ ì •ìƒ ì¢…ë£Œ ì‹œ íŒŒì¼ ì €ì¥
                document.getElementById('resultArea').style.display = 'block';
                const resultTitle = document.querySelector('#resultArea h4');
                resultTitle.textContent = 'ë…¹ìŒ ì™„ë£Œ!';
                const audioPlayer = document.getElementById('recordedAudio');
                const downloadBtn = document.getElementById('downloadBtn');
                audioPlayer.style.display = 'block';
                const blob = new Blob(recordedChunks, { type: 'audio/webm' });
                const url = URL.createObjectURL(blob);
                audioPlayer.src = url;
                downloadBtn.style.display = 'inline-block';
                downloadBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.style.display = 'none'; a.href = url;
                    a.download = `ë‚˜ì˜ë…¸ë˜ë°©-${songForRecording.title.trim()} - ${songForRecording.artist.trim()}.webm`;
                    document.body.appendChild(a); a.click(); document.body.removeChild(a);
                };
                recordedChunks = [];
            };
        }

        function getPitch() {
            if (!pitch || !isSinging) {
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
                return;
            }
            pitch.getPitch((err, frequency) => {
                if (isSinging) {
                    drawVisualizer(frequency || 0);
                    animationFrameId = requestAnimationFrame(getPitch);
                }
            });
        }
        
        /** ìƒíƒœ ì´ˆê¸°í™” (ìˆ˜ì •ë¨: recordedChunks ì´ˆê¸°í™” ì—­í•  ëª…í™•í™”) */
        function resetState() {
            // ë…¹ìŒ ë°ì´í„° ì²­í¬ ë°°ì—´ì„ ë¹„ì›ë‹ˆë‹¤.
            recordedChunks = [];
            // ë…¹ìŒ ê²°ê³¼ UIë¥¼ ìˆ¨ê¸°ê³  ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
            const resultArea = document.getElementById('resultArea');
            resultArea.style.display = 'none';
            resultArea.querySelector('h4').textContent = 'ë…¹ìŒ ì™„ë£Œ!';
            const recordedAudio = document.getElementById('recordedAudio');
            if (recordedAudio) recordedAudio.src = "";
            document.getElementById('downloadBtn').style.display = 'none';
            clearVisualizer();
        }