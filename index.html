<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÎÇòÏùò ÎÖ∏ÎûòÎ∞©</title>
    <script src="https://unpkg.com/ml5@0.6.1/dist/ml5.min.js"></script>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;text-align:center;background:#1a1a1a;color:#f0f0f0;margin:0;padding:20px;overflow-y:auto}
        h2{margin-top:0}
        #search-view{max-width:700px;margin:40px auto;padding:35px;background:linear-gradient(145deg,#2c3e50,#34495e);border-radius:20px;box-shadow:0 12px 35px rgba(0,0,0,.4)}
        .search-box{display:flex;margin-bottom:20px;border-radius:30px;overflow:hidden}
        #search-input{flex-grow:1;padding:10px 25px;font-size:16px;border:none;outline:none;color:#333;background:#f0f0f0}
        #search-button{padding:10px 30px;font-size:16px;font-weight:bold;border:none;background:#ffc107;color:#212529;cursor:pointer}
        #search-results{list-style:none;padding:0;margin:0;max-height:calc(100vh - 510px);overflow-y:auto}
        .result-item{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;border-bottom:1px solid rgba(255,255,255,.1);cursor:pointer}
        .result-item:hover{background:rgba(255,193,7,.2)}
        .title{font-weight:bold;color:#fff}
        .artist{font-size:.9em;color:#bdc3c7}
        #karaoke-view{max-width:680px;margin:0 auto}
        #playerContainer{position:relative;width:100%;padding-bottom:56.25%;height:0;overflow:hidden;background:#000;border-radius:12px}
        #ytplayer{position:absolute;top:0;left:0;width:100%;height:100%}
        button{padding:12px 25px;font-size:18px;font-weight:bold;margin:5px;border-radius:25px;border:none;color:#fff;cursor:pointer}
        #startBtn{background:#1DB954} #stopBtn{background:#F44336} #backBtn{background:#adb5bd;color:#212529}
        #resultArea{margin-top:20px}
        #visualizer{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1}
        @media(max-width:600px){#search-view{margin-top:20px;padding:20px}}
    </style>
</head>
<body>
    <!-- Í≤ÄÏÉâ ÌôîÎ©¥ -->
    <div id="search-view">
        <input type="text" id="search-input" placeholder="Í∞ÄÏàò Ïù¥Î¶Ñ ÎòêÎäî ÎÖ∏Îûò Ï†úÎ™© ÏûÖÎ†•...">
        <button id="search-button">Í≤ÄÏÉâ</button>
        <div id="search-results"></div>
    </div>

    <!-- ÎÖ∏ÎûòÎ∞© ÌôîÎ©¥ -->
    <div id="karaoke-view" style="display:none;">
        <canvas id="visualizer"></canvas>
        <div id="karaoke-container">
            <h2 id="karaoke-title"></h2>
            <div id="playerContainer"><div id="ytplayer"></div></div>
            <button id="startBtn" disabled>‚ñ∂ ÏãúÏûë</button>
            <button id="stopBtn" disabled>‚èπ Ï§ëÎã®</button>
            <button id="backBtn">üîç ÏÑ†Í≥°</button>
            <div id="resultArea" style="display:none;">
                <h4>ÎÖπÏùå ÏôÑÎ£å!</h4>
                <audio id="recordedAudio" controls style="width:100%;"></audio>
                <button id="downloadBtn" style="display:none;">üíæ Îã§Ïö¥Î°úÎìú</button>
            </div>
            <div id="mic-error-message" style="color:#ffc107;margin-top:15px;font-weight:bold;display:none;"></div>
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        /* ---------- Ï†ÑÏó≠ Î≥ÄÏàò ---------- */
        let pitch, audioStream, mediaRecorder, player, canvas, canvasCtx, animationFrameId, audioContext;
        let recordedChunks = [], currentPlaylist = [], currentPlaylistIndex = 0;
        let isSinging = false, isPlaylistMode = false, isPreparing = false, isStoppingManually = false;

        /* ---------- YouTube API Ï§ÄÎπÑ ---------- */
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('ytplayer', {
                height: '360',
                width: '640',
                playerVars: { controls: 0, modestbranding: 1, fs: 0 },
                events: { onReady: () => console.log('‚úÖ YouTube Ï§ÄÎπÑÎê®'), onStateChange: onPlayerStateChange }
            });
        }

        /* ---------- YouTube ÏÉÅÌÉú Î≥ÄÍ≤Ω ÏΩúÎ∞± ---------- */
        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                if (isPlaylistMode) {
                    currentPlaylistIndex++;
                    if (currentPlaylistIndex < currentPlaylist.length) {
                        prepareKaraoke(currentPlaylist[currentPlaylistIndex], true);
                    } else {
                        alert('ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏Í∞Ä Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.');
                        returnToSearchView();
                    }
                } else {
                    if (!isSinging) return;
                    isSinging = false;
                    isStoppingManually = false;
                    if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
                    if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; }
                    setTimeout(() => player && player.stopVideo(), 100);
                }
            }
        }

        /* ---------- ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏ ÏãúÏûë ---------- */
        function startPlaylist() {
            const list = JSON.parse(localStorage.getItem('karaokePlaylist') || '[]');
            if (list.length === 0) {
                alert('ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏Ïóê Í≥°Ïù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }
            currentPlaylist = list;
            currentPlaylistIndex = 0;
            prepareKaraoke(currentPlaylist[currentPlaylistIndex], true);
        }

        /* ---------- Í∏∞ÌÉÄ Ìï®Ïàò ---------- */
        async function prepareKaraoke(songData, isPlaylist = false) {
            if (isPreparing) return;
            isPreparing = true;
            document.getElementById('search-view').style.display = 'none';
            document.getElementById('karaoke-view').style.display = 'block';
            document.getElementById('karaoke-title').textContent = `${songData.title} - ${songData.artist}`;
            document.getElementById('mic-error-message').style.display = 'none';
            resetState();
            await cleanupAudioResources();
            isPlaylistMode = isPlaylist;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('startBtn').textContent = 'Ïû•ÎπÑ Ï§ÄÎπÑ Ï§ë...';

            try {
                if (player) player.cueVideoById(songData.videoId);
                if (!audioContext || audioContext.state === 'closed') {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioContext.state === 'suspended') await audioContext.resume();
                if (!isPlaylistMode) {
                    const constraints = { audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true } };
                    if (audioStream) audioStream.getTracks().forEach(t => t.stop());
                    audioStream = await navigator.mediaDevices.getUserMedia(constraints);
                    pitch = await new Promise((resolve, reject) => {
                        ml5.pitchDetection(
                            'https://cdn.jsdelivr.net/gh/ml5js/ml5-data-and-models/models/pitch-detection/crepe/',
                            audioContext,
                            audioStream,
                            (err, model) => (err ? reject(err) : resolve(model))
                        );
                    });
                    mediaRecorder = new MediaRecorder(audioStream);
                    setupMediaRecorder();
                }
                document.getElementById('startBtn').disabled = false;
                document.getElementById('startBtn').textContent = '‚ñ∂ ÏãúÏûë';
            } catch (err) {
                console.error(err);
                document.getElementById('mic-error-message').textContent = 'ÎßàÏù¥ÌÅ¨ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.';
                document.getElementById('mic-error-message').style.display = 'block';
            } finally {
                isPreparing = false;
            }
        }

        function startSinging() {
            if (isPreparing || !player) return;
            if (isPlaylistMode) {
                if (player.getPlayerState() !== YT.PlayerState.PLAYING) player.playVideo();
                document.getElementById('stopBtn').disabled = false;
                return;
            }
            if (!mediaRecorder || isSinging) return;
            isSinging = true;
            resetState();
            player.playVideo();
            mediaRecorder.start();
            getPitch();
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
        }

        function stopSinging() {
            if (isPlaylistMode) {
                if (player && player.getPlayerState() === YT.PlayerState.PLAYING) player.pauseVideo();
            } else {
                if (!isSinging) return;
                isSinging = false;
                isStoppingManually = true;
                if (player) player.stopVideo();
                if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
                document.getElementById('resultArea').style.display = 'none';
                if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; }
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            }
        }

        async function returnToSearchView() {
            if (player) player.stopVideo();
            await cleanupAudioResources();
            isSinging = false;
            isPlaylistMode = false;
            document.getElementById('karaoke-view').style.display = 'none';
            document.getElementById('search-view').style.display = 'block';
            document.getElementById('search-input').value = '';
        }

        async function cleanupAudioResources() {
            isSinging = false;
            isStoppingManually = false;
            if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; }
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                isStoppingManually = true;
                mediaRecorder.onstop = null;
                mediaRecorder.stop();
            }
            if (audioStream) audioStream.getTracks().forEach(t => t.stop());
            pitch = null;
            audioStream = null;
            mediaRecorder = null;
        }

        function setupMediaRecorder() {
            if (!mediaRecorder) return;
            mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
            mediaRecorder.onstop = () => {
                if (isStoppingManually) { recordedChunks = []; return; }
                const blob = new Blob(recordedChunks, { type: 'audio/webm' });
                const url = URL.createObjectURL(blob);
                const audioEl = document.getElementById('recordedAudio');
                const downloadBtn = document.getElementById('downloadBtn');
                document.getElementById('resultArea').style.display = 'block';
                document.getElementById('resultArea').querySelector('h4').textContent = 'ÎÖπÏùå ÏôÑÎ£å!';
                audioEl.src = url;
                downloadBtn.style.display = 'inline-block';
                downloadBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `ÎÇòÏùòÎÖ∏ÎûòÎ∞©-${document.getElementById('karaoke-title').textContent.trim()}.webm`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                };
            };
        }

        function getPitch() {
            if (!pitch || !isSinging) {
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
                return;
            }
            pitch.getPitch((err, frequency) => {
                if (isSinging) {
                    const canvas = document.getElementById('visualizer');
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = 'rgba(18,18,18,0.2)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    if (!frequency) return;
                    const barCount = 60;
                    const barWidth = canvas.width / barCount / 2;
                    const ratio = Math.max(0, Math.min(1, (frequency - 80) / (500 - 80)));
                    const hue = (1 - ratio) * 240;
                    const height = ratio * canvas.height * 0.8;
                    for (let i = 0; i < barCount; i++) {
                        const dist = Math.abs(i - barCount / 2);
                        const h = Math.max(0, height * (1 - dist / (barCount / 1.8)));
                        const x = canvas.width / 2 + (i - barCount / 2) * (barWidth * 1.8);
                        ctx.fillStyle = `hsl(${hue},100%,65%)`;
                        ctx.fillRect(x, canvas.height - h, barWidth, h);
                    }
                    animationFrameId = requestAnimationFrame(getPitch);
                }
            });
        }

        function resetState() {
            recordedChunks = [];
            document.getElementById('resultArea').style.display = 'none';
            document.getElementById('recordedAudio').src = '';
            document.getElementById('downloadBtn').style.display = 'none';
            const canvas = document.getElementById('visualizer');
            if (canvas) canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
        }

        /* ---------- Í≤ÄÏÉâ Í∏∞Îä• ---------- */
        window.onload = () => {
            const searchBtn = document.getElementById('search-button');
            const searchInput = document.getElementById('search-input');
            searchBtn.addEventListener('click', () => fetchAndRenderResults());
            searchInput.addEventListener('keydown', e => { if (e.key === 'Enter') fetchAndRenderResults(); });
            document.getElementById('backBtn').addEventListener('click', returnToSearchView);
            document.getElementById('startBtn').addEventListener('click', startSinging);
            document.getElementById('stopBtn').addEventListener('click', stopSinging);
            document.getElementById('visualizer').width = window.innerWidth;
            document.getElementById('visualizer').height = window.innerHeight;
            fetchAndRenderResults();
        };
    </script>
</body>
</html>