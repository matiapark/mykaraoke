<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>ë‚˜ì˜ ë…¸ë˜ë°©</title>
    <script src="https://unpkg.com/nosleep.js@0.12.0/dist/NoSleep.min.js"></script>
    <script src="https://unpkg.com/ml5@0.6.1/dist/ml5.min.js"></script>
    <style>
        /* CSS ìŠ¤íƒ€ì¼ì€ ì´ì „ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ë©ë‹ˆë‹¤ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            text-align: center;
            background: #1a1a1a;
            color: #f0f0f0;
            margin: 0;
            padding: 20px;
            overflow-y: auto;
            touch-action: manipulation;
        }
        h2 { margin-top: 0; }
        #search-view {
            max-width: 700px;
            margin: 40px auto;
            padding: 35px;
            background: linear-gradient(145deg, #2c3e50, #34495e);
            border-radius: 20px;
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .title-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
        }
        .title-wrapper h2 {
            font-size: 2.8em;
            font-weight: 700;
            color: #ffffff;
            margin: 0 20px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3), 0 0 20px rgba(255, 193, 7, 0.5);
        }
        .search-box {
            display: flex;
            margin-bottom: 20px;
            border-radius: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        #search-input {
            flex-grow: 1;
            padding: 10px 25px;
            font-size: 16px;
            border: none;
            outline: none;
            color: #333;
            background: #f0f0f0;
        }
        #search-button {
            padding: 10px 30px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            background: #ffc107;
            color: #212529;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .view-toggle-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 20px;
        }
        .view-toggle-buttons button {
            flex-grow: 1;
            padding: 10px;
            font-size: 14px;
            font-weight: bold;
            color: #f0f0f0;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .view-toggle-buttons button.active {
            background-color: #ffc107;
            color: #212529;
            border-color: #ffc107;
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
        }
        #search-results {
            list-style: none; padding: 0; margin: 0;
            max-height: calc(100vh - 510px); overflow-y: auto;
        }
        .result-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 20px; cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: left; transition: background-color 0.3s ease;
        }
        .result-item:hover {
            background: linear-gradient(90deg, rgba(255, 193, 7, 0.2), rgba(255, 193, 7, 0));
        }
        .result-item .title { font-size: 1.1em; font-weight: bold; margin-bottom: 4px; color: #ffffff; }
        .result-item .artist { font-size: 0.9em; color: #bdc3c7; }
        .list-buttons { display: flex; gap: 10px; }
        .favorite-btn, .playlist-add-btn, .playlist-remove-btn {
            font-size: 24px; cursor: pointer; padding: 5px;
            transition: transform 0.2s ease, color 0.2s ease; color: #fff;
        }
        .favorite-btn.favorited { color: #ffc107; }
        .playlist-add-btn.added { color: #28a745; }
        #playerContainer { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; background: #000; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.5); margin: 15px 0; }
        #ytplayer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        button { padding: 12px 25px; font-size: 18px; font-weight: bold; margin: 5px; cursor: pointer; border-radius: 25px; border: none; color: white; transition: all 0.2s ease-in-out; }
        #startBtn { background-color: #1DB954; }
        #startBtn:disabled { background-color: #555; cursor: not-allowed; }
        #stopBtn { background-color: #F44336; }
        #backBtn { background-color: #adb5bd; color: #212529; }
        #resultArea { margin-top: 20px; }
        #downloadBtn { background-color: #007bff; margin-left: 10px; }
    </style>
</head>
<body>
    <div id="search-view">
      <header>
          <div class="title-wrapper"><h2>ğŸ¤ ë‚˜ì˜ ë…¸ë˜ë°©</h2></div>
          <div class="search-box">
              <input type="text" id="search-input" placeholder="ê°€ìˆ˜ ì´ë¦„ ë˜ëŠ” ë…¸ë˜ ì œëª© ì…ë ¥...">
              <button id="search-button">ê²€ìƒ‰</button>
          </div>
      </header>
      <div class="view-toggle-buttons">
          <button id="show-search-btn" class="active">ì „ì²´ ê²€ìƒ‰</button>
          <button id="show-favorites-btn">â­ ì¦ê²¨ì°¾ê¸°</button>
          <button id="show-recents-btn">ğŸ•“ ìµœê·¼ ë¶€ë¥¸ ê³¡</button>
          <button id="show-playlist-btn">ğŸ¶ ì—°ì† ë¶€ë¥´ê¸°</button>
      </div>
      <div id="search-results-container"><ul id="search-results"></ul></div>
      <div id="load-more-container" style="text-align: center; margin-top: 20px;">
          <button id="loadMoreBtn" style="display: none;">ë” ë³´ê¸°</button>
      </div>
    </div>
    <div id="karaoke-view" style="display: none;">
      <div id="karaoke-container">
        <header><h2 id="karaoke-title"></h2></header>
        <div id="playerContainer"><div id="ytplayer"></div></div>
        <footer>
          <div>
            <button id="startBtn" disabled>â–¶ ì‹œì‘</button>
            <button id="stopBtn" disabled>â¹ ì¤‘ë‹¨</button>
            <button id="backBtn">ğŸ” ì„ ê³¡</button>
          </div>
          <div id="resultArea" style="display:none;">
            <h4>ë…¹ìŒ ì™„ë£Œ!</h4>
            <audio id="recordedAudio" controls style="width: 100%;"></audio>
            <button id="downloadBtn" style="display: none;">ğŸ’¾ ë‹¤ìš´ë¡œë“œ</button>
          </div>
        </footer>
      </div>
    </div>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        // --- ì „ì—­ ë³€ìˆ˜ ---
        let pitch, mediaRecorder, player, audioContext;
        let micSourceNode, micGainNode; // ## ALGORITHM: ê°€ìƒ ë¯¹ì„œ(Gain) ë…¸ë“œ ì¶”ê°€
        let recordedChunks = [], currentSongData = null;
        let isSinging = false, isPreparing = false, isStoppingManually = false;
        // (UI ê´€ë ¨ ë³€ìˆ˜ë“¤ì€ ìƒëµ)

        window.onload = () => {
            // UI ìš”ì†Œ í• ë‹¹ ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • (ìƒëµ)
        };
        
        function onYouTubeIframeAPIReady() { /* ìƒëµ */ }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED && isSinging) {
                stopSinging();
            }
            if (event.data === YT.PlayerState.PAUSED && isSinging && !isStoppingManually) {
                player.playVideo();
            }
        }

        async function prepareKaraoke(songData) {
            isPreparing = true;
            currentSongData = songData;
            // UI ì „í™˜ (ìƒëµ)
            await cleanupAudioResources();
            resetState();
            player.cueVideoById(songData.videoId);
            startBtn.disabled = false;
            stopBtn.disabled = true;
            isPreparing = false;
        }

        async function startSinging() {
            if (isPreparing || isSinging) return;
            isSinging = true;
            isStoppingManually = false;

            try {
                // ## ALGORITHM: ì˜¤ë””ì˜¤ íŒŒì´í”„ë¼ì¸ ì¬ì„¤ê³„ ##
                // 1. ì›ë³¸ ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ ê°€ì ¸ì˜¤ê¸°
                const rawMicStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true, noiseSuppression: true } });
                
                // 2. ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ë° ê°€ìƒ ë¯¹ì„œ(GainNode) ìƒì„±
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                micSourceNode = audioContext.createMediaStreamSource(rawMicStream);
                micGainNode = audioContext.createGain();
                micGainNode.gain.value = 1; // ê¸°ë³¸ ë³¼ë¥¨ì€ 1(ìµœëŒ€)

                // 3. ë…¹ìŒê¸°ì™€ ìŒì • ë¶„ì„ê¸°ë¡œ ë³´ë‚¼ ìƒˆë¡œìš´ 'ì²˜ë¦¬ëœ' ìŠ¤íŠ¸ë¦¼ ìƒì„±
                const destinationNode = audioContext.createMediaStreamDestination();
                micSourceNode.connect(micGainNode);
                micGainNode.connect(destinationNode);
                const processedStream = destinationNode.stream;

                // 4. ë…¹ìŒê¸°ì™€ ìŒì • ë¶„ì„ê¸°ë¥¼ 'ì²˜ë¦¬ëœ' ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ì´ˆê¸°í™”
                mediaRecorder = new MediaRecorder(processedStream);
                setupMediaRecorder(currentSongData);

                pitch = await new Promise((resolve, reject) => {
                    ml5.pitchDetection('https://cdn.jsdelivr.net/gh/ml5js/ml5-data-and-models/models/pitch-detection/crepe/', audioContext, processedStream, (err, model) => {
                        err ? reject(err) : resolve(model);
                    });
                });

                // 5. ëª¨ë“  ì»´í¬ë„ŒíŠ¸ ì‹œì‘
                player.playVideo();
                mediaRecorder.start();
                getPitch();

                startBtn.disabled = true;
                stopBtn.disabled = false;
            } catch (err) {
                console.error("ì˜¤ë””ì˜¤ ì‹œì‘ ì‹¤íŒ¨:", err);
                isSinging = false;
            }
        }

        /** 'ì¤‘ë‹¨' ë²„íŠ¼: ë…¸ë˜ì™€ ëª¨ë“  ê´€ë ¨ ë¦¬ì†ŒìŠ¤ë¥¼ 'ë¶€ë“œëŸ½ê²Œ' ì¤‘ì§€í•©ë‹ˆë‹¤. */
        function stopSinging() {
            if (!isSinging) return;
            isStoppingManually = true;
            isSinging = false;
            
            startBtn.disabled = true;
            stopBtn.disabled = true;

            // ## ALGORITHM: í˜ì´ë“œ ì•„ì›ƒ ë¡œì§ ##
            if (micGainNode && audioContext && audioContext.state === 'running') {
                // 1. ë³¼ë¥¨ì„ 0.1ì´ˆì— ê±¸ì³ 0ìœ¼ë¡œ ì¤„ì„ (í˜ì´ë“œ ì•„ì›ƒ)
                micGainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.1);

                // 2. í˜ì´ë“œ ì•„ì›ƒì´ ëë‚œ í›„, ë¯¸ë””ì–´ë¥¼ ì •ì§€ì‹œí‚´
                setTimeout(() => {
                    if (player) player.stopVideo();
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.stop(); // .onstop ì´ë²¤íŠ¸ì—ì„œ ìµœì¢… cleanupì´ ì‹¤í–‰ë¨
                    }
                }, 150);
            } else {
                // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ê°€ ì—†ëŠ” ê²½ìš°, ë°”ë¡œ ì •ë¦¬
                if (player) player.stopVideo();
                cleanupAudioResources().then(() => {
                    startBtn.disabled = false;
                });
            }
        }

        function returnToSearchView() {
            if (isSinging) stopSinging();
            else cleanupAudioResources();
            // UI ì „í™˜ (ìƒëµ)
        }

        /** MediaRecorder ì„¤ì • ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ */
        function setupMediaRecorder(songForRecording) {
            mediaRecorder.ondataavailable = e => {
                if (e.data.size > 0) recordedChunks.push(e.data);
            };
            
            // ë…¹ìŒì´ ì™„ì „íˆ ë©ˆì·„ì„ ë•Œ ì‹¤í–‰ë˜ëŠ” ì´ë²¤íŠ¸
            mediaRecorder.onstop = () => {
                if (!isStoppingManually) {
                    // UI ì—…ë°ì´íŠ¸ ë° íŒŒì¼ ìƒì„± (ìƒëµ)
                }
                // ëª¨ë“  ì‘ì—…ì´ ëë‚œ í›„ ìµœì¢…ì ìœ¼ë¡œ ì˜¤ë””ì˜¤ ë¦¬ì†ŒìŠ¤ ì •ë¦¬
                cleanupAudioResources().then(() => {
                    if(startBtn) startBtn.disabled = false;
                });
            };
        }

        /** ëª¨ë“  ì˜¤ë””ì˜¤ ê´€ë ¨ ë¦¬ì†ŒìŠ¤ë¥¼ ì•ˆì „í•˜ê²Œ í•´ì œ (ê°€ì¥ ë§ˆì§€ë§‰ì— í˜¸ì¶œ) */
        async function cleanupAudioResources() {
            // ì›ë³¸ ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ì˜ íŠ¸ë™ì„ ì¤‘ì§€
            if (micSourceNode && micSourceNode.mediaStream) {
                micSourceNode.mediaStream.getTracks().forEach(track => track.stop());
            }

            if (audioContext && audioContext.state !== 'closed') {
                await audioContext.close();
            }
            
            micSourceNode = null;
            micGainNode = null;
            audioContext = null;
            pitch = null;
            mediaRecorder = null;
            recordedChunks = [];
        }

        function getPitch() { /* ìƒëµ */ }
        function resetState() { /* ìƒëµ */ }
        
        // ë‚˜ë¨¸ì§€ UI ë° ë°ì´í„° ê´€ë¦¬ í•¨ìˆ˜ë“¤ (ìƒëµ)

    </script>
</body>
</html>