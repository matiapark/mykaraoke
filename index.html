
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìˆ˜ì •ëœ ë…¸ë˜ë°©</title>
  <script src="https://unpkg.com/ml5@0.6.1/dist/ml5.min.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <style>
    body { font-family: sans-serif; background-color: #1a1a1a; color: #fff; text-align: center; padding: 20px; }
    button { padding: 10px 20px; margin: 10px; font-size: 16px; border: none; border-radius: 5px; }
    #startBtn { background-color: #28a745; color: white; }
    #stopBtn { background-color: #dc3545; color: white; }
  </style>
</head>
<body>

  <h2 id="karaoke-title">ğŸ¤ ë…¸ë˜ ì œëª© - ê°€ìˆ˜</h2>
  <div id="playerContainer" style="width:640px; height:360px; margin:auto;">
    <div id="ytplayer"></div>
  </div>
  <button id="startBtn">ì‹œì‘</button>
  <button id="stopBtn">ì¤‘ë‹¨</button>

  <div id="resultArea" style="margin-top:20px; display:none;">
    <h4>ë…¹ìŒ ì™„ë£Œ!</h4>
    <audio id="recordedAudio" controls></audio>
    <button id="downloadBtn" style="display:none;">ë‹¤ìš´ë¡œë“œ</button>
  </div>

  <script>
    let player, mediaRecorder, audioStream, recordedChunks = [];
    let isSinging = false, isStoppingManually = false;
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const karaokeTitle = document.getElementById('karaoke-title');

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('ytplayer', {
        height: '360',
        width: '640',
        videoId: 'M7lc1UVf-VE',
        events: {
          'onStateChange': onPlayerStateChange
        }
      });
    }

    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.ENDED) {
        if (isSinging) {
          isStoppingManually = false;
          if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
          }
        }
      }
    }

    async function startSinging() {
      if (isSinging) return;
      try {
        audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(audioStream);
        mediaRecorder.ondataavailable = e => {
          if (e.data.size > 0) recordedChunks.push(e.data);
        };
        mediaRecorder.onstop = () => {
          if (isStoppingManually) {
            isStoppingManually = false;
            return;
          }
          const blob = new Blob(recordedChunks, { type: 'audio/webm' });
          const url = URL.createObjectURL(blob);
          const audioPlayer = document.getElementById('recordedAudio');
          audioPlayer.src = url;
          audioPlayer.style.display = 'block';
          const downloadBtn = document.getElementById('downloadBtn');
          downloadBtn.style.display = 'inline-block';
          downloadBtn.onclick = () => {
            const a = document.createElement('a');
            a.href = url;
            a.download = `ë‚˜ì˜ë…¸ë˜ë°©-${karaokeTitle.textContent.trim()}.webm`;
            a.click();
          };
          document.getElementById('resultArea').style.display = 'block';
          recordedChunks = [];
        };
        mediaRecorder.start();
        player.seekTo(0);
        player.playVideo();
        isSinging = true;
        startBtn.disabled = true;
        stopBtn.disabled = false;
      } catch (err) {
        alert("ë§ˆì´í¬ ì ‘ê·¼ ì˜¤ë¥˜: " + err.message);
      }
    }

    async function stopSinging() {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        isStoppingManually = true;
        mediaRecorder.stop();
      }
      if (player) {
        player.pauseVideo();
        player.seekTo(0);
      }
      isSinging = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }

    startBtn.onclick = startSinging;
    stopBtn.onclick = stopSinging;
  </script>
</body>
</html>
