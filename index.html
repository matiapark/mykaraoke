<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>나의 노래방</title>
    <script src="https://unpkg.com/ml5@0.6.1/dist/ml5.min.js"></script>
    <style>
        /* (기존 CSS 동일) */
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;text-align:center;background:#1a1a1a;color:#f0f0f0;margin:0;padding:20px;overflow-y:auto}
        h2{margin-top:0} /* ... 이하 생략 ... */
    </style>
</head>
<body>
    <!-- 기존 마크업 동일 -->
    <div id="search-view"> ... </div>
    <div id="karaoke-view" style="display: none;"> ... </div>
    <video id="noSleepVideo" loop playsinline muted style="position:absolute;left:-100px;top:-100px;width:1px;height:1px;opacity:0;"></video>
    <audio id="startSfx" src="https://touch-game.s3.ap-northeast-2.amazonaws.com/final_success.mp3" preload="auto"></audio>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        /* ---------- 전역 변수 ---------- */
        let pitch, audioStream, mediaRecorder, player, canvas, canvasCtx, animationFrameId, audioContext;
        let recordedChunks = [], currentPlaylist = [], currentPlaylistIndex = 0;
        let isSinging = false, isPlaylistMode = false, isPreparing = false, isStoppingManually = false;
        let currentQuery = '', currentPage = 1, totalPages = 1, debounceTimer, currentView = 'search';

        /* ---------- DOM 참조 ---------- */
        let searchView, karaokeView, searchInput, searchButton, searchResultsUl, loadMoreBtn, playlistControls;
        let startBtn, stopBtn, backBtn, micErrorMessage, headphoneGuide;
        let noSleepVideo, showSearchBtn, showFavoritesBtn, showRecentsBtn, showPlaylistBtn, startPlaylistBtn;

        /* ---------- 초기화 ---------- */
        window.onload = () => {
            /* (기존 요소 할당 동일) */
            searchView = document.getElementById('search-view'); /* ... */
            karaokeView = document.getElementById('karaoke-view');
            searchInput = document.getElementById('search-input');
            searchButton = document.getElementById('search-button');
            searchResultsUl = document.getElementById('search-results');
            loadMoreBtn = document.getElementById('loadMoreBtn');
            playlistControls = document.getElementById('playlist-controls');
            canvas = document.getElementById('visualizer');
            noSleepVideo = document.getElementById('noSleepVideo');
            showSearchBtn = document.getElementById('show-search-btn');
            showFavoritesBtn = document.getElementById('show-favorites-btn');
            showRecentsBtn = document.getElementById('show-recents-btn');
            showPlaylistBtn = document.getElementById('show-playlist-btn');
            startPlaylistBtn = document.getElementById('start-playlist-btn');
            startBtn = document.getElementById('startBtn');
            stopBtn = document.getElementById('stopBtn');
            backBtn = document.getElementById('backBtn');
            micErrorMessage = document.getElementById('mic-error-message');
            headphoneGuide = document.getElementById('headphone-guide');

            if (canvas) {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                canvasCtx = canvas.getContext('2d');
            }

            /* (이벤트 바인딩 동일) */
            showSearchBtn.addEventListener('click', () => switchView('search'));
            showFavoritesBtn.addEventListener('click', () => switchView('favorites'));
            showRecentsBtn.addEventListener('click', () => switchView('recents'));
            showPlaylistBtn.addEventListener('click', () => switchView('playlist'));
            startPlaylistBtn.addEventListener('click', startPlaylist);
            searchInput.addEventListener('input', () => {
                if (currentView !== 'search') switchView('search');
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => startNewSearch(), 500);
            });
            searchButton.addEventListener('click', startNewSearch);
            searchInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    clearTimeout(debounceTimer);
                    startNewSearch();
                }
            });
            loadMoreBtn.addEventListener('click', () => {
                currentPage++;
                fetchAndRenderResults();
            });
            backBtn.onclick = returnToSearchView;
            stopBtn.onclick = stopSinging;
            startBtn.onclick = startSinging;

            document.getElementById('power-guide').addEventListener('click', () => {
                alert("💡 기능 및 유의사항 안내\n\n1. 배터리 및 슬립모드\n...\n3. 녹음 기능 활용 팁\n...");
            });

            createDecorations('.left', 5, 3);
            createDecorations('.right', 5, 3);

            /* ---------- 🔧 추가: suspend 복구 ---------- */
            window.addEventListener('focus', async () => {
                if (audioContext && audioContext.state === 'suspended') {
                    await audioContext.resume();
                    console.log('AudioContext resumed on focus');
                }
            });
        };

        /* ---------- YouTube API ---------- */
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('ytplayer', {
                height: '360',
                width: '640',
                playerVars: { controls: 0, modestbranding: 1, fs: 0 },
                events: {
                    onReady: () => console.log('✅ YouTube 준비됨'),
                    onStateChange: onPlayerStateChange
                }
            });
        }

        /* ---------- 상태 관리 ---------- */
        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                if (isPlaylistMode) {
                    currentPlaylistIndex++;
                    if (currentPlaylistIndex < currentPlaylist.length) {
                        const nextSong = currentPlaylist[currentPlaylistIndex];
                        prepareKaraoke(nextSong, true);
                    } else {
                        alert('플레이리스트가 종료되었습니다.');
                        returnToSearchView();
                    }
                } else {
                    if (!isSinging) return;
                    isSinging = false;
                    isStoppingManually = false;
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                    }
                    disableNoSleep();
                    if (animationFrameId) {
                        cancelAnimationFrame(animationFrameId);
                        animationFrameId = null;
                    }
                    setTimeout(() => player && player.stopVideo(), 100);
                }
            }
        }

        /* ---------- 노래방 핵심 로직 ---------- */
        async function prepareKaraoke(songData, isPlaylist = false) {
            if (isPreparing) return;
            isPreparing = true;
            searchView.style.display = 'none';
            karaokeView.style.display = 'block';
            document.getElementById('karaoke-title').textContent = `${songData.title} - ${songData.artist}`;
            micErrorMessage.style.display = 'none';
            headphoneGuide.style.display = 'flex';
            resetState();
            await cleanupAudioResources();

            isPlaylistMode = isPlaylist;
            if (!isPlaylistMode) addRecentSong(songData);

            startBtn.disabled = true;
            stopBtn.disabled = true;
            startBtn.textContent = '장비 준비 중...';

            try {
                if (player) player.cueVideoById(songData.videoId);

                /* 🔧 수정된 오디오 준비 부분 */
                if (!audioContext || audioContext.state === 'closed') {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }

                if (!isPlaylistMode) {
                    const constraints = {
                        audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
                    };
                    if (audioStream) audioStream.getTracks().forEach(t => t.stop());
                    audioStream = await navigator.mediaDevices.getUserMedia(constraints);

                    pitch = await new Promise((resolve, reject) => {
                        ml5.pitchDetection(
                            'https://cdn.jsdelivr.net/gh/ml5js/ml5-data-and-models/models/pitch-detection/crepe/',
                            audioContext,
                            audioStream,
                            (err, model) => (err ? reject(err) : resolve(model))
                        );
                    });
                    mediaRecorder = new MediaRecorder(audioStream);
                    setupMediaRecorder();
                }

                startBtn.disabled = false;
                startBtn.textContent = '▶ 시작';
            } catch (err) {
                console.error('오디오 준비 실패:', err);
                micErrorMessage.textContent =
                    '마이크 연결을 확인해주세요. 권한이 없다면 주소창의 자물쇠를 클릭해 허용해주세요.';
                micErrorMessage.style.display = 'block';
            } finally {
                isPreparing = false;
            }
        }

        function startSinging() {
            if (isPreparing || !player) return;
            if (isPlaylistMode) {
                if (player.getPlayerState() !== YT.PlayerState.PLAYING) {
                    player.playVideo();
                    stopBtn.disabled = false;
                }
                return;
            }
            if (!mediaRecorder || isSinging) return;
            isSinging = true;
            resetState();
            headphoneGuide.style.display = 'none';
            const resultArea = document.getElementById('resultArea');
            resultArea.style.display = 'block';
            resultArea.querySelector('h4').textContent = '녹음 중...';
            document.getElementById('recordedAudio').style.display = 'none';
            document.getElementById('downloadBtn').style.display = 'none';
            player.playVideo();
            mediaRecorder.start();
            getPitch();
            enableNoSleep();
            startBtn.disabled = true;
            stopBtn.disabled = false;
        }

        function stopSinging() {
            if (isPlaylistMode) {
                if (player && player.getPlayerState() === YT.PlayerState.PLAYING) player.pauseVideo();
            } else {
                if (!isSinging) return;
                isSinging = false;
                isStoppingManually = true;
                if (player) player.stopVideo();
                if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
                document.getElementById('resultArea').style.display = 'none';
                disableNoSleep();
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }
                startBtn.disabled = false;
                stopBtn.disabled = true;
            }
        }

        async function returnToSearchView() {
            if (player) player.stopVideo();
            await cleanupAudioResources();
            isSinging = false;
            isPlaylistMode = false;
            karaokeView.style.display = 'none';
            searchView.style.display = 'block';
            searchInput.value = '';
            switchView('search');
        }

        async function cleanupAudioResources() {
            isSinging = false;
            isStoppingManually = false;
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                isStoppingManually = true;
                mediaRecorder.onstop = null;
                mediaRecorder.stop();
            }
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
            }
            pitch = null;
            audioStream = null;
            mediaRecorder = null;
        }

        /* ---------- 헬퍼 함수 (기존 동일) ---------- */
        function setupMediaRecorder() {
            if (!mediaRecorder) return;
            mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
            mediaRecorder.onstop = () => {
                if (isStoppingManually) { recordedChunks = []; return; }
                const resultArea = document.getElementById('resultArea');
                const audioPlayer = document.getElementById('recordedAudio');
                const downloadBtn = document.getElementById('downloadBtn');
                resultArea.style.display = 'block';
                resultArea.querySelector('h4').textContent = '녹음 완료!';
                audioPlayer.style.display = 'block';
                downloadBtn.style.display = 'inline-block';
                const blob = new Blob(recordedChunks, { type: 'audio/webm' });
                const url = URL.createObjectURL(blob);
                audioPlayer.src = url;
                downloadBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `나의노래방-${document.getElementById('karaoke-title').textContent.trim()}.webm`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                };
            };
        }
        function getPitch() {
            if (!pitch || !isSinging) {
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
                return;
            }
            pitch.getPitch((err, frequency) => {
                if (isSinging) {
                    drawVisualizer(frequency || 0);
                    animationFrameId = requestAnimationFrame(getPitch);
                }
            });
        }
        function resetState() {
            recordedChunks = [];
            document.getElementById('resultArea').style.display = 'none';
            const recordedAudio = document.getElementById('recordedAudio');
            if (recordedAudio) recordedAudio.src = '';
            document.getElementById('downloadBtn').style.display = 'none';
            clearVisualizer();
        }
        function clearVisualizer() { if (canvasCtx) canvasCtx.clearRect(0, 0, canvas.width, canvas.height); }
        function enableNoSleep() { noSleepVideo.play().catch(e => console.error('NoSleep 비디오 재생 실패:', e)); }
        function disableNoSleep() { noSleepVideo.pause(); }

        /* ---------- 나머지 검색/UI 관련 함수들 (변경 없음) ---------- */
        function createDecorations(containerSelector, starCount, balloonCount) { /* ... */ }
        function switchView(view) { /* ... */ }
        const getFavorites = () => JSON.parse(localStorage.getItem('karaokeFavorites') || '[]');
        const saveFavorites = (favorites) => localStorage.setItem('karaokeFavorites', JSON.stringify(favorites));
        const getRecents = () => JSON.parse(localStorage.getItem('karaokeRecents') || '[]');
        const addRecentSong = (songData) => { /* ... */ };
        const getPlaylist = () => JSON.parse(localStorage.getItem('karaokePlaylist') || '[]');
        const savePlaylist = (playlist) => localStorage.setItem('karaokePlaylist', JSON.stringify(playlist));
        function renderFavorites() { renderSongList(getFavorites()); }
        function renderRecents() { renderSongList(getRecents()); }
        function renderPlaylist() { /* ... */ }
        function movePlaylistItem(index, direction) { /* ... */ }
        function startNewSearch() { /* ... */ }
        async function fetchAndRenderResults() { /* ... */ }
        function renderSongList(songs) { /* ... */ }
        function toggleFavorite(songData, btnElement) { /* ... */ }
        function addSongToPlaylist(songData, btnElement) { /* ... */ }
        function removeSongFromPlaylist(videoId) { /* ... */ }
        function startPlaylist() { /* ... */ }
    </script>
</body>
</html>