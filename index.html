function endSingingSession() {
    isStoppingManually = true;

    // 1. 플레이어는 정지하고 처음으로 되돌립니다.
    if (player) {
        player.pauseVideo();
        player.seekTo(0);
    }
    
    // 2. 오디오 관련 모든 리소스를 중지하고, 참조를 완전히 제거(null)합니다.
    if (!isPlaylistMode) {
        disableNoSleep();
        
        // 애니메이션 프레임 중지
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }

        // 녹음기 이벤트 핸들러를 먼저 제거하고 중지
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.onstop = null;
            mediaRecorder.ondataavailable = null;
            mediaRecorder.stop();
        }
        mediaRecorder = null; // 객체 참조 제거

        // 오디오 스트림의 모든 트랙 중지
        if (audioStream) {
            audioStream.getTracks().forEach(track => track.stop());
        }
        audioStream = null; // 객체 참조 제거

        // 오디오 컨텍스트 닫기
        if (audioContext && audioContext.state !== 'closed') {
            audioContext.close();
        }
        audioContext = null; // 객체 참조 제거
        
        pitch = null; // pitch 객체 참조 제거
    }
    
    // 3. UI 상태를 초기화합니다.
    document.getElementById('resultArea').style.display = 'none';
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
}