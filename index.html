<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>노래방 시스템 - 슬립 모드 개선판</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Malgun Gothic', Arial, sans-serif;
            background-color: #000;
            overflow: hidden;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        #video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 100;
            background-color: #000;
        }
        
        #video-player {
            width: 100%;
            height: 100%;
            object-fit: contain;
            outline: none;
        }
        
        #sleep-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 200;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: #fff;
            font-size: 2rem;
            text-align: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s;
        }
        
        #sleep-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        #wake-up-button {
            margin-top: 30px;
            padding: 15px 40px;
            background-color: #ff3366;
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .system-message {
            margin-bottom: 20px;
            color: #ccc;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <div id="video-container">
        <video id="video-player" playsinline webkit-playsinline></video>
    </div>
    
    <div id="sleep-overlay">
        <p>시스템이 대기 모드입니다</p>
        <div class="system-message">화면을 터치하여 계속...</div>
        <button id="wake-up-button">시스템 시작</button>
    </div>

    <script>
        // 시스템 상태 변수
        const systemState = {
            isSleeping: false,
            isVideoEnded: false,
            sleepTimer: null,
            wakeLock: null,
            lastActivityTime: Date.now()
        };

        // DOM 요소
        const elements = {
            videoPlayer: document.getElementById('video-player'),
            sleepOverlay: document.getElementById('sleep-overlay'),
            wakeUpButton: document.getElementById('wake-up-button')
        };

        // 시스템 초기화
        function initSystem() {
            setupEventListeners();
            loadSampleVideo();
            startActivityMonitor();
            
            // Wake Lock API 지원 시 사용 (화면 꺼짐 방지)
            requestWakeLock();
        }

        // 이벤트 리스너 설정
        function setupEventListeners() {
            // 비디오 이벤트
            elements.videoPlayer.addEventListener('ended', handleVideoEnded);
            elements.videoPlayer.addEventListener('pause', handleVideoPause);
            elements.videoPlayer.addEventListener('play', handleVideoPlay);
            elements.videoPlayer.addEventListener('timeupdate', handleVideoTimeUpdate);
            
            // 슬립 모드 해제 이벤트
            elements.wakeUpButton.addEventListener('click', wakeUpSystem);
            document.addEventListener('click', handleUserActivity);
            document.addEventListener('touchstart', handleUserActivity);
            document.addEventListener('keydown', handleUserActivity);
            
            // 페이지 가시성 변경 이벤트
            document.addEventListener('visibilitychange', handleVisibilityChange);
        }

        // 샘플 비디오 로드 (실제 사용 시 경로 수정 필요)
        function loadSampleVideo() {
            elements.videoPlayer.src = 'sample_video.mp4';
            elements.videoPlayer.load();
            
            elements.videoPlayer.play().catch(error => {
                console.error('자동 재생 실패:', error);
                // 사용자 상호작용 필요 시 처리
            });
        }

        // 비디오 이벤트 핸들러
        function handleVideoEnded() {
            console.log('비디오 재생 완료');
            systemState.isVideoEnded = true;
            startSleepTimer(5000); // 5초 후 슬립 모드 진입
        }

        function handleVideoPause() {
            if (!systemState.isVideoEnded && !systemState.isSleeping) {
                console.log('비디오 일시정지 - 슬립 타이머 시작');
                startSleepTimer(30000); // 30초 후 슬립 모드
            }
        }

        function handleVideoPlay() {
            console.log('비디오 재생 - 슬립 타이머 취소');
            cancelSleepTimer();
            systemState.isVideoEnded = false;
            systemState.lastActivityTime = Date.now();
        }

        function handleVideoTimeUpdate() {
            systemState.lastActivityTime = Date.now();
        }

        // 사용자 활동 감지
        function handleUserActivity() {
            if (systemState.isSleeping) return;
            
            systemState.lastActivityTime = Date.now();
            cancelSleepTimer();
            
            if (elements.videoPlayer.paused && !systemState.isVideoEnded) {
                elements.videoPlayer.play().catch(console.error);
            }
        }

        // 슬립 모드 관리
        function startSleepTimer(delay) {
            cancelSleepTimer();
            systemState.sleepTimer = setTimeout(() => {
                enterSleepMode();
            }, delay);
        }

        function cancelSleepTimer() {
            if (systemState.sleepTimer) {
                clearTimeout(systemState.sleepTimer);
                systemState.sleepTimer = null;
            }
        }

        function enterSleepMode() {
            if (systemState.isSleeping) return;
            
            console.log('슬립 모드 진입');
            systemState.isSleeping = true;
            
            // 비디오 정지 및 리소스 해제
            elements.videoPlayer.pause();
            elements.videoPlayer.removeAttribute('src');
            elements.videoPlayer.load();
            
            // 슬립 오버레이 표시
            elements.sleepOverlay.classList.add('active');
            
            // 성능 최적화
            document.body.style.backgroundColor = '#000';
        }

        function wakeUpSystem() {
            if (!systemState.isSleeping) return;
            
            console.log('슬립 모드 해제');
            systemState.isSleeping = false;
            systemState.isVideoEnded = false;
            
            // 슬립 오버레이 숨김
            elements.sleepOverlay.classList.remove('active');
            
            // 시스템 재초기화
            loadSampleVideo();
            
            // 하드웨어 가속 강제 갱신
            void elements.videoPlayer.offsetHeight;
        }

        // 활동 모니터링
        function startActivityMonitor() {
            setInterval(() => {
                const inactiveTime = Date.now() - systemState.lastActivityTime;
                if (!systemState.isSleeping && inactiveTime > 60000) { // 1분 이상 활동 없음
                    console.log('장시간 사용자 활동 없음 - 슬립 모드 진입');
                    enterSleepMode();
                }
            }, 30000); // 30초마다 체크
        }

        // 페이지 가시성 변경 처리
        function handleVisibilityChange() {
            if (document.hidden) {
                if (!systemState.isSleeping) {
                    elements.videoPlayer.pause();
                    startSleepTimer(10000); // 10초 후 슬립 모드
                }
            } else {
                if (!systemState.isSleeping && systemState.isVideoEnded) {
                    startSleepTimer(5000); // 다시 5초 후 슬립 모드
                }
            }
        }

        // Wake Lock API (화면 꺼짐 방지)
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    systemState.wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock 활성화');
                    
                    systemState.wakeLock.addEventListener('release', () => {
                        console.log('Wake Lock 해제됨');
                    });
                }
            } catch (err) {
                console.error('Wake Lock 실패:', err);
            }
        }

        // DOM 로드 완료 후 시스템 초기화
        window.addEventListener('DOMContentLoaded', initSystem);
        
        // 오류 처리
        window.addEventListener('error', (event) => {
            console.error('시스템 오류:', event.error);
        });
    </script>
</body>
</html>